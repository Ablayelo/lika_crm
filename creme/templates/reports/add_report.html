{% extends "creme_core/base.html" %}

{% block extrahead %}
    <script language="javascript">
        $(document).ready(function() {
            document.getElementById('trfilter').style.display = 'none';
            document.getElementById('preview_div').style.display = 'none';
            document.getElementById('trcolumn').style.display = 'none';
            document.getElementById('trgenerate').style.display = 'none';
            document.getElementById('trcustomops').style.display = 'none';

            document.getElementById('up').disabled = 'disabled';
            document.getElementById('down').disabled = 'disabled';

            document.getElementById('hidden').style.display = 'none';

            $('#add_operation').attr('disabled', 'disabled');

            {% if report %}
                $('#ct').val({{report.ct.id}});
                $('#ct').change();
                $('#column').val([{% for field in report.fields.all %}'{{field.name}}',{% endfor%}]);
                addItem();
                $('#filter').val({{report.filter.id|default:0}});

                {% for foperation in report.getFieldsOperations %}
                    $('#ops').val("{{foperation.operation.operator}}");
                    $("#columnscustom").val("{{foperation.field.name}}");
                    addOperation();
                {% endfor %}
            {% endif %}
        })
    </script>

    <script type="text/javascript" src="{{MEDIA_URL}}js/models/reports.js"></script>
{% endblock %}


{% block content %}
    <!--
        {% cycle "block_header_line_light" "block_header_line_dark" as header_row %}
        {% cycle "block_line_light" "block_line_dark" as row_color %}
    -->


    <form method="post" action="/reports/ajax/generate" id="myform">
        <input type="hidden" name="operations_list" id="operations_list" value="">
        <input type="hidden" name="report_id" id="report_id" value="{{report.id}}">

        <h2>Préparation d'un nouveau rapport :</h2>

        <table class="table_detail_view ui-corner-all">
            <tbody class="collapsable">
                <tr>
                    <th class="{% cycle header_row %}" align="left">
                        <font color="black">Etape 1</font> : Nom de votre rapport
                    </th>
                    <td>
                        <input type="text" name="name" id="name" size="35" value="{{report.name}}" />
                    </td>
                </tr>

                <tr>
                    <th class="{% cycle header_row %}" align="left">
                        <font color="black">Etape 2</font> : Sélection de la ressource associée au rapport
                    </th>
                    <td>
                        <select name="ct" id="ct" onchange="loadColumn();loadFilters(this);">
                            {% for ct in cts %}
                            <option value="{{ct.id}}">{{ct}}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>

                <tr id="trcolumn">
                    <th class="{% cycle header_row %}" align="left">
                        <font color="black">Etape 3</font> : Filtrage des colonnes de la ressource
                    </th>
                    <td>
                        <table border="0" cellpadding="3" cellspacing="0">
                            <tr>
                                <td>
                                    <select name="column" id="column" multiple size="6">
                                    </select>
                                </td>
                                <td align="left">
                                    <img src="{{MEDIA_URL}}images/add_16.png" border="0" onclick="addItem()"><br>
                                    <img src="{{MEDIA_URL}}images/delete_22.png" width="16" height="16" border="0" onclick="delItem()"><br>
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td valign="bottom">
                                                <img src="{{MEDIA_URL}}images/delete_22.png" width="16" height="16" border="0" onclick="cleanAll()">
                                            </td>
                                            <td valign="top">
                                                all
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td>
                                    <select name="recapcolumn" id="recapcolumn" multiple size="6" onchange="checkUpandDown()">
                                    </select>
                                </td>
                                <td align="center">
                                    <button type="button" id="up" onclick="upItem()">Monter</button><br>
                                    <button type="button" id="down" onclick="downItem()">Descendre</button>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr id="trfilter">
                    <th class="{% cycle header_row %}" align="left">
                        <font color="black">Etape 4</font> : Filtrage du résultat (optionnel)
                    </th>
                    <td>
                        <select name="filter" id="filter" onchange="loadEntities()">
                            {% for filter in filters %}
                                <option value="{{filter.id}}">{{filter}}</option>
                            {% endfor %}
                        </select>
                        <img src="{{MEDIA_URL}}images/view_16.png" border="0" onclick="editFilter()">
                        <img src="{{MEDIA_URL}}images/delete_22.png" width="16" height="16" border="0" onclick="delFilter()">
                        ou créer un nouveau filtre : <img src="{{MEDIA_URL}}images/add_16.png" border="0" onclick="addFilter()">
                    </td>
                </tr>

                <tr id="trcustomops">
                    <th class="{% cycle header_row %}" align="left">
                        <font color="black">Etape 5</font> : Opérations spécifiques (optionel)
                    </th>
                    <td>
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td>
                                    <select id="ops" name="ops" onchange="loadAcceptedColumns(this)">
                                        {% for operation in operations %}
                                            <option value="{{operation.operator}}">{{operation.name}}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td width="10"></td>
                                <td>
                                    <select id="columnscustom" name="columnscustom" multiple>
                                    </select>
                                </td>
                                <td width="10"></td>
                                <td>
                                    <button type="button" onclick="addOperation();" id="add_operation">Ajouter l'opération</button>
                                </td>
                                <td width="10"></td>
                                <td>
                                    <div id="appercuop"></div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr id="trgenerate">
                    <th class="{% cycle header_row %}" align="left">
                        <font color="black">Etape 6</font> : Génération du rapport au format tableur
                    </th>
                    <td>
                        <input type="hidden" value="" name="fields_list" id="fields_list">
                        {% comment %}
                        <input type="button" value="Sauver et générer le rapport en csv" onclick="prepareSubmit('CSV')">
                        <input type="button" value="Sauver et générer le rapport en odt" onclick="prepareSubmit('ODT')">
                        <input type="button" value="Sauver" onclick="prepareSubmit('SIMPLE');" />
                        {% endcomment %}
                        <input type="button" value="Sauver" onclick="saveReport();"></input>
                    </td>
                </tr>
            </tbody>
        </table>

        <div id="preview_div"></div>

        <div id="hidden"></div>
    </form>
    <br/><br/>
{% endblock %}