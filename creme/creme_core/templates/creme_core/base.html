{% load i18n %}{% load media %}
{% load creme_menu %}{% load creme_core_tags %}{% load creme_search %}{% load creme_quickforms %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="{{ LANGUAGE_CODE }}" xml:lang="{{ LANGUAGE_CODE }}" {% if LANGUAGE_BIDI %}dir="rtl"{% endif %}>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8" />
    <title>Creme CRM{% block page_title %}{% endblock %}</title>
    {% include_media 'main.css' %}
    {% include "creme_core/frags/js_header.html" %}
    <link rel="shortcut icon" href="{% media_url 'images/favicon.ico' %}" type="image/x-icon" />
    <style type="text/css">
        .fg-menu-container { z-index: 100; }
    </style>
    <script type='text/javascript'>
        $(document).ready(function() {
           var document_width_onload  = $(document).width();
           var document_height_onload = $(document).height();

           function activeEventsMenu() {
                //'fast' transition makes bugs in chrome < 6.1
                $("#menu_collapse").mouseenter(function(e) {
                    $("#menu_expanded").show('fast');
                    $("#menu_collapse").hide('fast');
                });

                $("#menu_expanded").mouseleave(function(e) {
                    $("#menu_expanded").hide('fast');
                    $("#menu_collapse").show('fast');
                });
            }

            function desactiveEventsMenu() {
                $("#menu_collapse").unbind('mouseenter');
                $("#menu_expanded").unbind('mouseleave');
            }

            function resizePageElements(menu_width, expanded) {
                var top = $('#top');
                var content = $('#content');
                var footer = $('#footer');

                var margin_left = (expanded) ? menu_width + 5 + 'px' : menu_width;

                top.css('margin-left', margin_left);
                content.css('margin-left', margin_left);
                footer.css('margin-left', margin_left);

                var new_width = document_width_onload - menu_width;
                if(expanded) new_width -=10;
                top.width(new_width);
                content.width(new_width);
                footer.width(new_width);
            }

            //var content_height = $("#content").height()+$("#footer").height()+$("#top").height();//$('#footer').offset().top;//
            var logo_container_height = $('#logo_container').outerHeight();
            //var max_menu_height = content_height - logo_container_height;

            var height = $('#menu_expanded').height();

            $('#menu').menu({
                content: $('#tree_menu2').html(),
                flyOut: false,
                backLink: false,
                alwaysOpen:true,
                maxHeight: height,
                crumbDefaultText : '{% trans "Menu" %}',
                topLinkText : '{% trans "Back to Top" %}'
            });

            $('#menu').hide();
            $('.fg-menu-container')
                .appendTo('#menu_expanded')
                .css({'top': logo_container_height, 'bottom':'auto'});
                //.css({'top': logo_container_height, 'height':max_menu_height, 'bottom':'auto'});

            $("#menu_expanded").width($('.fg-menu-container').outerWidth());

            $('.pinmenu').toggle(
             //Pin / Fixer le menu
             function() {
                $(this).attr('src', '{% media_url "images/unpin.png" %}');
                desactiveEventsMenu();
                resizePageElements($("#menu_expanded").outerWidth(), true);
                $.cookie('menu_creme', 'expanded', {expires: 7, path: '/', domain: '', secure: false});
             },
             //Unpin / Rendre le menu flottant
             function() {
                $(this).attr('src', '{% media_url "images/pin.png" %}');
                activeEventsMenu();
                resizePageElements($("#menu_collapse").outerWidth(), false);
                $.cookie('menu_creme', 'collapse', {expires: 7, path: '/', domain: '', secure: false});
             }
            );

           if($.cookie('menu_creme') == 'expanded') {
                $('.pinmenu').attr('src', '{% media_url "images/unpin.png" %}');
                desactiveEventsMenu();
                $("#menu_expanded").show('fast',resizePageElements($("#menu_expanded").outerWidth(), true));
                $("#menu_collapse").hide('fast');
           } else {
               $('.pinmenu').attr('src', '{% media_url "images/pin.png" %}');
               activeEventsMenu();
               $("#menu_expanded").hide('slow');
               $("#menu_collapse").show('fast', resizePageElements($("#menu_collapse").outerWidth(), false));
           }
      });
    </script>
     {% block extrahead %}{% endblock %}
    <script type='text/javascript'>{% comment %}TODO: move in js file{% endcomment %}
      $(document).ready(function() {
        $("#menu_collapse").css('height', $(document).height());
        $("#menu_expanded").css('height', $(document).height());

        $('[role=menuitem]', '#menu_expanded').bind('menu-item-selected', function(e, menu){
            e.stopImmediatePropagation();
            var href = $('a:first', this).attr('href');
            //$.cookie('creme-menu-selected', href);
            creme.utils.go_to($('a:first',this).attr('href'), false);
        });

        (function bind_scroll() {
            $(window).scroll(function(){
                var $menu = $('.fg-menu-container');

                if ($(this).scrollTop() > $('#logo_container').outerHeight()){
                    $menu.addClass('top_fixed');
                    $menu.css("left", -$(window).scrollLeft()+"px");
                }
                else{
                    $menu.removeClass('top_fixed');
                }
            });
        })();
      });

      window.onload = function() {
        //var content_height = $("#content").height()+$("#footer").height()+$("#top").height();//Is better but detailviews has float div so we have a very small height size
        /*var content_height = $(document).height();
        var logo_container_height = $('#logo_container').outerHeight();
        var max_menu_height = content_height - logo_container_height;

        $('.fg-menu-container').css({'top': logo_container_height, 'height':max_menu_height, 'bottom':'auto'});
        $('.fg-menu').css('height', max_menu_height*0.9);
        allUIMenus[0].setMaxHeight(max_menu_height*0.9);
        $('#menu_collapse').height(content_height*0.9);*/

        //var previous_selected = $.cookie('creme-menu-selected');

        var logo_container_height = $('#logo_container').outerHeight();//Webkit
        $('.fg-menu-container').css({'top': logo_container_height});//Webkit

        var previous_selected = window.location.pathname;

        if(previous_selected != null) {
            var $initial = $('#menu_expanded div.fg-menu-container').find('[href="'+previous_selected+'"]');
            var $ul = null;

            var li_stack = [];
            var more = true;

            var $li = $initial.parent('li');
            li_stack.push($li);

            var max_deep = 30;//I think the depth of the folder will not go more than 30 (which is already huge)
            var deep = 0;

            while(more && deep <= max_deep) { //Set max deep to avoid max recursion
                var ul = $li.parent('ul');
                $li = ul.parent('li');
                if($li.size() == 0) more = false;
                else li_stack.push($li);
                deep++;
            }

            var now = +new Date;

            for(var i = li_stack.length-1; i > 0; i--) {
                li_stack[i].find('a:first').click();
            }
        }
      };
      </script>
</head>
<body {% block bodyclass %}{% endblock %}>
    {% block side_menu %}
        <div id="menu_collapse" class="ui-corner-all menu_collapse">
            <img src="{% media_url 'images/favicon.ico' %}"/>
            M<br/>
            E<br/>
            N<br/>
            U<br/>
            &nbsp;<br/>
            C<br/>
            R<br/>
            E<br/>
            M<br/>
            E<br/>
        </div>
        <div id="menu_expanded" class="menu_expanded">
            <div id="logo_container">
                <center>
                    <a href="/"><img src="{% media_url logo_url %}" alt="Logo" class="logo pointer"/></a>
                </center>
            </div>
            {% block sidebar %}
                <a tabindex="0" href="#tree_menu2" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="menu">
                    Menu
                </a>
                <div id="tree_menu2" style="display:none;">
                 {% generate_treecreme_menu request %}
                </div>
            {% endblock %}
        </div>
    {% endblock %}

    {% block top_bar %}
        <div id="top" class="header">
            <div class="widget">
                {% trans 'Welcome,' %} <strong>{% if user.first_name %}{{ user.first_name|escape }}{% else %}{{ user.username }}{% endif %}</strong> -
                {% block userlinks %}
                    <a href="/creme_config/user/view/settings/">{% trans 'My settings' %}</a> -
                    <a href="/creme_core/clean/">{% trans 'Log out' %}</a>
                {% endblock %}
            </div>
            <div class="widget major">
                {% get_search_panel %}
                {% get_quickforms_panel %}
            </div>
            <div class="widget last">{% comment %}:last-child is buggy so think to add last css class to the last element{% endcomment %}
                <a href="/"><img src="{% media_url 'images/creme_header_50.png' %}" alt="CrÃ¨me" border="0" /></a>
            </div>
            <div class="spacer"></div>
        </div>
    {% endblock %}

    <div id="content" class="main_content">
        {% block last_viewed_items %}
            {% get_last_items_menu request %}
        {% endblock %}

        {% block prefered_menu %}
            {% get_prefered_menu request %}
        {% endblock %}

        <div id="sub_content">
            {% block before_content_1 %}
            {% endblock %}

            {% block before_content_2 %}
            {% endblock %}

            {% block before_content_3 %}
            {% endblock %}

            {% block content %}
            {% endblock %}

            {% block after_content_1 %}
            {% endblock %}

            {% block after_content_2 %}
            {% endblock %}

            {% block after_content_3 %}
            {% endblock %}
        </div>
    </div>

    <div id="footer">
        <a href="http://hybird.org">{% trans "About Hybird" %}</a> - 2009-2011 &nbsp;&nbsp;&nbsp;Creme v{{creme_version}} {% if django_version %}&nbsp;&nbsp;&nbsp;(Django {{django_version}}){% endif %}
    </div>
    <script type="text/javascript">
        $(document).ready(function(){
            creme.blocks.bindEvents();
        });
    </script>
</body>
</html>
