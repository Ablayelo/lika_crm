{% extends "creme_core/detailview.html" %}

{% load i18n %}
{% load creme_core_tags %}
{% load queryset_tags %}
{% load report_tags %}
{% load graph_tags %}

{% block page_title %} - {% blocktrans %}Rendered {{object}}{% endblocktrans %}{% endblock %}

{% block extrahead %}
{{block.super}}
<script type="text/javascript" src="{{MEDIA_URL}}js/libs/graphael/prod/raphael-1.5.2.min.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}js/libs/graphael/prod/g.raphael-min.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}js/libs/graphael/prod/g.line-min.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}js/libs/graphael/prod/g.pie-min.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}js/libs/graphael/prod/g.dot-min.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}js/libs/graphael/prod/g.bar-min.js"></script>
<script type='text/javascript' src='{{MEDIA_URL}}js/datejs/date-fr-FR.js'></script>{# TODO: i18n  datejs has 150 availables languages#}
<script type="text/javascript" src="{{MEDIA_URL}}js/creme/creme.graphael.js"></script>
{% endblock %}

{% block before_content_1 %}
    <table class="table_header" cellpadding="0" cellspacing="0">
        <tr>
            <td width="5%"><img src="{{MEDIA_URL}}images/graph_64.png" alt="{% trans "Graph" %}"/></td>
            <td width="70%">
                <h1>
                    {% blocktrans with object|get_meta_value:"verbose_name"|title as verbose_name and object|title as title %}Rendered {{verbose_name}} : {{title}}{% endblocktrans %}
                </h1>
            </td>
            <td width="25%" align="right">
                <span>
                    <a href="{{object.report.get_absolute_url}}">
                        <img src="{{MEDIA_URL}}images/left_arrow_64.png" title="{% blocktrans %}Back to the detailview : '{{object}}'{% endblocktrans %}" alt="{% trans "Back" %}"/>
                    </a>&nbsp;
                </span>
            </td>
        </tr>
    </table>
{% endblock %}

{% block content %}
    {% with 4 as colspan %}
        <div style="position:relative; width:100%;">
            <table class="table_detail_view ui-corner-all" >
                <thead>
                    <tr>
                        <th colspan="{{colspan}}">{{object}}</th>
                    </tr>
                </thead>
                <tbody class="collapsable">
                    <tr class="{% cycle "block_header_line_dark" "block_header_line_light" %}">
                        <th>{% trans 'Generation date' %} : <span id="graph_gen_date_{{object.id}}"></span></td>
                        <th>
                            <select id="graph_type_{{object.id}}" onchange="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{object.id}}/'+$('#graph_ordering_{{object.id}}').val(), $(this).val(), '.graph_container_{{object.id}}', '{{object|verbose_ordinate:object.ordinate}}', '{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}', '#graph_gen_date_{{object.id}}');">
                                <option value="histogram">{% trans 'Histogram' %}</option>
                                <option value="pie">{% trans 'Pie' %}</option>
                            </select>
                        </th>
                        <th nowrap>
                            {% trans 'Sorting' %}:
                            <select id="graph_ordering_{{object.id}}" onchange="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{object.id}}/'+$(this).val(), $('#graph_type_{{object.id}}').val(),'.graph_container_{{object.id}}', '{{object|verbose_ordinate:object.ordinate}}', '{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}', '#graph_gen_date_{{object.id}}');">
                                <option value="ASC">{% trans 'Ascending' %}</option>
                                <option value="DESC">{% trans 'Descending' %}</option>
                            </select>
                        </th>
                        <th>
                            <a onclick="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{object.id}}/'+$('#graph_ordering_{{object.id}}').val(), $('#graph_type_{{object.id}}').val(), '.graph_container_{{object.id}}', '{{object|verbose_ordinate:object.ordinate}}', '{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}', '#graph_gen_date_{{object.id}}');">
                                <img src="{{MEDIA_URL}}/images/refresh_22.png" alt="{% trans 'Regenerate' %}" title="{% trans 'Regenerate' %}" />
                            </a>
                        </th>
                    </tr>
                    <tr>
                        <td colspan="{{colspan}}">
                            <div class="graph_container_{{object.id}}" style="postion:relative;width: 80%; height: 100%;"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endwith %}
    <script type="text/javascript">
        var x = [];
        var y = [];
        {% with object.fetch as graph_fetch %}
            {% with graph_fetch.0 as x %}
                {% for v in x %}
                    x.push("{{v|default:""}}");
                {% endfor %}
            {% endwith %}
            {% with graph_fetch.1 as y %}
                {% for v in y %}
                    y.push("{{v|default:0}}");
                {% endfor %}
            {% endwith %}
        {% endwith %}

        var now = +new Date;
        var loading_id = 'loading_'+now;
        var node = creme.graphael.init('.graph_container_{{object.id}}');
        var date_node = $('#graph_gen_date_{{object.id}}');
        creme.graphael.simple_barchart({
               'instance': node.data('graphael'),
               'container':node,
               'x': x,
               'y': y,
               'gen_date_selector': '#graph_gen_date_{{object.id}}',
               'abscissa_lbl': "{{object|verbose_ordinate:object.ordinate}}",
               'ordinate_lbl': "{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}"
        });
    </script>
{% endblock %}