{% extends "creme_core/detailview.html" %}
{% load i18n %}
{% load creme_core_tags creme_widgets creme_queryset %}
{% load report_tags graph_tags %}

{% block page_title %} - {% blocktrans %}Rendered {{object}}{% endblocktrans %}{% endblock %}

{% block before_content_1 %}
    <table class="table_header" cellpadding="0" cellspacing="0">
        <tr>
            <td class="logo">{% get_image_for_object object 'big' %}</td>
            <td class="title">
                <h1>
                    {% blocktrans with verbose_name=object|get_meta_value:"verbose_name"|title title=object|title %}Rendered {{verbose_name}} : {{title}}{% endblocktrans %}
                </h1>
            </td>
            <td class="actions">
                <span>
                    <a href="{{object.report.get_absolute_url}}">
                        <img src="{% creme_media_url 'images/previous_64.png' %}" title="{% blocktrans %}Back to the detailview : '{{object}}'{% endblocktrans %}" alt="{% trans "Back" %}"/>
                    </a>&nbsp;
                </span>
            </td>
        </tr>
    </table>
{% endblock %}

{% block content %}
    {% comment %}  TODO : REMOVE IT !
    {% with 5 as colspan %}
        <div style="position:relative; width:100%;">
            <table class="table_detail_view ui-corner-all" >
                <thead>
                    <tr>
                        <th colspan="{{colspan}}">{{object}}</th>
                    </tr>
                </thead>
                <tbody class="collapsable">
                    <tr class="{% cycle "block_header_line_dark" "block_header_line_light" %} header">
                        <th>{% trans 'Generation date' %} : <span id="graph_gen_date_{{object.id}}"></span></th>
                        <th>
                            <select id="graph_type_{{object.id}}" onchange="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{object.id}}/'+$('#graph_ordering_{{object.id}}').val(), $(this).val(), '.graph_container_{{object.id}}', '{{object|verbose_ordinate:object.ordinate}}', '{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}', '#graph_gen_date_{{object.id}}');">
                                <option value="histogram">{% trans 'Histogram' %}</option>
                                <option value="pie">{% trans 'Pie' %}</option>
                            </select>
                        </th>
                        <th nowrap>
                            {% trans 'Sorting' %}:
                            <select id="graph_ordering_{{object.id}}" onchange="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{object.id}}/'+$(this).val(), $('#graph_type_{{object.id}}').val(),'.graph_container_{{object.id}}', '{{object|verbose_ordinate:object.ordinate}}', '{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}', '#graph_gen_date_{{object.id}}');">
                                <option value="ASC">{% trans 'Ascending' %}</option>
                                <option value="DESC">{% trans 'Descending' %}</option>
                            </select>
                        </th>
                        <th>
                            <a onclick="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{object.id}}/'+$('#graph_ordering_{{object.id}}').val(), $('#graph_type_{{object.id}}').val(), '.graph_container_{{object.id}}', '{{object|verbose_ordinate:object.ordinate}}', '{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}', '#graph_gen_date_{{object.id}}');">
                                {% trans 'Regenerate' as img_title %}<img src="{% creme_media_url 'images/refresh_22.png' %}" alt="{{img_title}}" title="{{img_title}}" />
                            </a>
                        </th>
                        <th>
                            {% if user_can_admin_report %}
                                <a onclick="creme.utils.showInnerPopup('/reports/graph/{{object.id}}/block/add');">
                                    {% trans 'Create a block with this graph' as img_title %}<img src="{% creme_media_url 'images/add_22.png' %}" alt="{{img_title}}" title="{{img_title}}" />
                                </a>
                            {% else %}
                                {% trans "Can't add" as img_title %}<img class="forbidden" src="{% creme_media_url 'images/add_22.png' %}" alt="{{img_title}}" title="{{img_title}}" />
                            {% endif %}
                        </th>
                    </tr>
                    <tr class="content">
                        <td colspan="{{colspan}}">
                            <div class="graph_container_{{object.id}}" style="postion:relative;width: 80%; height: 100%;"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endwith %}
    <script type="text/javascript">
        var x = [];
        var y = [];
        {% with object.fetch as graph_fetch %}
            {% with graph_fetch.0 as x %}
                {% for v in x %}
                    x.push("{{v|default:""}}");
                {% endfor %}
            {% endwith %}
            {% with graph_fetch.1 as y %}
                {% for v in y %}
                    y.push("{{v|default:0}}");
                {% endfor %}
            {% endwith %}
        {% endwith %}

        var now = +new Date;
        var loading_id = 'loading_'+now;
        var node = creme.graphael.init('.graph_container_{{object.id}}');
        var date_node = $('#graph_gen_date_{{object.id}}');
        creme.graphael.simple_barchart({
               'instance': node.data('graphael'),
               'container':node,
               'x': x,
               'y': y,
               'gen_date_selector': '#graph_gen_date_{{object.id}}',
               'ordinate_lbl': "{{object|verbose_ordinate:object.ordinate}}",
               'abscissa_lbl': "{{object|verbose_abscissa:object.abscissa}}  - {{verbose_report_graph_types|get_value:object.type}}"
        });
    </script>
    {% endcomment %}
    {% comment %}Â NEW VERSION OF GRAPH ! {% endcomment %}
    {% get_report_chart object %}
{% endblock %}
