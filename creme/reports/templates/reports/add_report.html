{% extends "creme_core/generics/blockform/add.html" %}

{% block extrahead %}
    <script type="text/javascript" src="{{MEDIA_URL}}js/models/reports.js"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            $('#{{form.ct.auto_id}}').change(function(){
                var opts = {
                    'ct':this,
                    'hf':'#{{form.hf.auto_id}}',//'#hf',
                    'show_after_ct':'.show_after_ct',
                    'filter':'#{{form.filter.auto_id}}',
                    'columns':
                        {
                            'table_id':'{{form.columns.auto_id}}',
                            'name' : '{{form.columns.name}}'
                        },
                    'cf' :
                        {
                            'table_id':'{{form.custom_fields.auto_id}}',
                            'name' : '{{form.custom_fields.name}}'
                        },
                    'relations' :
                        {
                            'table_id':'{{form.relations.auto_id}}',
                            'name' : '{{form.relations.name}}'
                        },
                    'functions' :
                        {
                            'table_id':'{{form.functions.auto_id}}',
                            'name' : '{{form.functions.name}}'
                        },
                    'aggregates' : [
                        {% for aggregate in form.aggregates %}
                        {
                            'target_node': 'id_{{aggregate.name}}',
                            'input_name' : '{{aggregate.name}}',
                            'name': '{{aggregate.name}}'
                        }{% ifnotequal forloop.counter form.aggregates|length %},{% endifnotequal %}{# Prevent trailing comma incompatible with IE #}
                        {% endfor %}
                    ]
                };
                creme.reports.load(opts);
            });

            {% if ct_posted %}
                $('#{{form.ct.auto_id}}').val('{{ct_posted}}');
            {% endif %}

            $('#{{form.ct.auto_id}}').change();

            
        });
    </script>
{% endblock %}