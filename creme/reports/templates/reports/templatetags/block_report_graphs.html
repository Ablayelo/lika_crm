{% load i18n %}{% load media %}
{% load creme_core_tags %}{% load creme_block %}
{% load graph_tags %}
{% has_perm_to change object.report as has_perm %}
<table class="table_detail_view ui-corner-all {{ state.classes }}" id={{block_name}}>
    {% get_block_header colspan=6 %}
        <th style="width: 80%;" class="collapser" align="left">{% get_block_title _('%s Graph') _('%s Graphs') 'graph_48.png' 'Graph' %}</th>
        <th style="width: 20%;" align="right">
            <div class="buttons">
                {% comment %}<a class="add" onclick="creme.utils.innerPopupNReload('/reports/graph/{{object.id}}/add', {% get_block_reload_uri %});">
                    <img src="{% media_url 'images/add_22.png' %}" border="0" title="{% trans 'Add new graph' %}" alt="{% trans 'Add' %}" />{% trans 'New' %}
                </a>{% endcomment %}
                {% get_line_adder at_url '/reports/graph/{{object.id}}/add' with_label _("Add new graph") with_perms has_perm %}
            </div>
        </th>
    {% end_get_block_header %}
    <tbody class="collapsable">
        {% if page.paginator.count %}
            <tr>
                <th class="block_header_line_dark" style="width:20px;">&nbsp;</th>
                {% get_column_header _('Name') 'name' %}
                {% get_column_header _('Column abscissa') 'abscissa' %}
                {% get_column_header _('Column ordinate') 'ordinate' %}
                {% get_column_header _('Type') 'type' %}
                <th class="block_header_line_dark">{% trans 'Actions' %}</th>
            </tr>
            {% for graph in page.object_list %}
                <!--{% cycle "block_line_dark" "block_line_light" as row_color %}-->
                <tr>
                    <td class="{{row_color}}" style="width:20px;">
                        <img class="pointer report_graph_{{graph.id}}" src="{% media_url 'images/expandme.gif' %}" alt="{% trans 'Expand' %}" title="{% trans 'Expand' %}"/>
                        <img class="pointer report_graph_{{graph.id}}_expanded" src="{% media_url 'images/expanded.gif' %}" alt="{% trans 'Reduce' %}" title="{% trans 'Reduce' %}" style="display:none;"/>
                    </td>
                    <td class="{{row_color}}"><a href="{{graph.get_absolute_url}}">{{graph.name}}</a></td>
                    <td class="{{row_color}}">{{graph|verbose_abscissa:graph.abscissa}}</td>
                    <td class="{{row_color}}">{{graph|verbose_ordinate:graph.ordinate}}</td>
                    <td class="{{row_color}}">{{verbose_report_graph_types|get_value:graph.type}}{% if graph.days %} ({{graph.days}}){% endif %}</td>
                    <td class="{{row_color}}" align="center" valign="center" style="width:10%;">
                        {% has_perm_to change graph as graph_edit_perm %}
                        {% has_perm_to delete graph as graph_delete_perm %}
                        {% if graph_edit_perm %}
                            <a onclick="creme.utils.innerPopupNReload('/reports/graph/edit/{{graph.id}}', {% get_block_reload_uri %});">
                                <img src="{% media_url 'images/edit_22.png' %}" alt="{% trans 'Edit' %}" title="{% trans 'Edit' %}" border="0">
                            </a>
                        {% else %}
                            <img class="forbidden" src="{% media_url 'images/edit_22.png' %}" border="0" title="{% trans "Can't edit" %}" alt="{% trans "Can't edit" %}" />
                        {% endif %}
                        {% get_line_deletor at_url '/creme_core/delete_js' with_args "{'ids' : '{{graph.id}}' }" with_perms graph_delete_perm %}
                    </td>
                </tr>
                <tr>
                    <td class="{{row_color}} graph_global_container_{{graph.id}}" colspan="6" style="display: none;">
                        <div>
                            <table width="100%">
                                <tbody>
                                    <tr>
                                        <td>{% trans 'Generation date' %} : <span id="graph_gen_date_{{graph.id}}"></span></td>
                                        <td>
                                            <select id="graph_type_{{graph.id}}" onchange="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{graph.id}}/'+$('#graph_ordering_{{graph.id}}').val(), $(this).val(), '.graph_container_{{graph.id}}', '{{graph|verbose_ordinate:graph.ordinate}}', '{{graph|verbose_abscissa:graph.abscissa}}  - {{verbose_report_graph_types|get_value:graph.type}}', '#graph_gen_date_{{graph.id}}');">
                                                <option value="histogram">{% trans 'Histogram' %}</option>
                                                <option value="pie">{% trans 'Pie' %}</option>
                                            </select>
                                        </td>
                                        <td nowrap>
                                            {% trans 'Sorting' %}:
                                            <select id="graph_ordering_{{graph.id}}" onchange="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{graph.id}}/'+$(this).val(), $('#graph_type_{{graph.id}}').val(),'.graph_container_{{graph.id}}', '{{graph|verbose_ordinate:graph.ordinate}}', '{{graph|verbose_abscissa:graph.abscissa}}  - {{verbose_report_graph_types|get_value:graph.type}}', '#graph_gen_date_{{graph.id}}');">
                                                <option value="ASC">{% trans 'Ascending' %}</option>
                                                <option value="DESC">{% trans 'Descending' %}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <a onclick="creme.graphael.simple_refetch('/reports/graph/fetch_graph/{{graph.id}}/'+$('#graph_ordering_{{graph.id}}').val(), $('#graph_type_{{graph.id}}').val(), '.graph_container_{{graph.id}}', '{{graph|verbose_ordinate:graph.ordinate}}', '{{graph|verbose_abscissa:graph.abscissa}}  - {{verbose_report_graph_types|get_value:graph.type}}', '#graph_gen_date_{{graph.id}}');">
                                                <img src="{% media_url 'images/refresh_22.png' %}" alt="{% trans 'Regenerate' %}" title="{% trans 'Regenerate' %}" />
                                            </a>
                                        </td>
                                        <td>
                                            {% if user_can_admin_report %}
                                                <a onclick="creme.utils.innerPopupNReload('/reports/graph/{{graph.id}}/block/add', {% get_block_reload_uri %});">
                                                    <img src="{% media_url 'images/add_22.png' %}" alt="{% trans 'Create a block' %}" title="{% trans 'Create a block with this graph' %}" />
                                                </a>
                                            {% else %}
                                                <img class="forbidden" src="{% media_url 'images/add_22.png' %}" alt="{% trans "Can't add" %}" title="{% trans "Can't add" %}" />
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {% comment %}<div class="graph_container_{{graph.id}}" style="overflow-x:scroll;"></div>{% endcomment %}
                        <div class="graph_container_{{graph.id}}" style="overflow-x:scroll;postion:relative;"></div>
                    </td>
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="4" class="block_line_dark">{% trans 'No graphs registered for the moment' %}</td>
            </tr>
        {% endif %}
    </tbody>
    {% include 'creme_core/templatetags/widgets/block_footer.html' %}
</table>

<script type="text/javascript">
    {% with today|to_timestamp as now %}
        var selector_{{now}} = [];

        {% for graph in page.object_list %}
            var x = [];
            var y = [];

            {% with graph.fetch as graph_fetch %}
                {% with graph_fetch.0 as x %}
                    {% for v in x %}
                        x.push("{{v|default:""}}");
                    {% endfor %}
                {% endwith %}

                {% with graph_fetch.1 as y %}
                    {% for v in y %}
                        y.push("{{v|default:0}}");
                    {% endfor %}
                {% endwith %}
            {% endwith %}

            selector_{{now}}.push({
                'shower':   '.report_graph_{{graph.id}}',
                'hider':    '.report_graph_{{graph.id}}_expanded',
                'wrapper':  '.graph_global_container_{{graph.id}}',
                'container':'.graph_container_{{graph.id}}',
                'x': x,
                'y': y,
                'graph_id': '{{graph.id}}',
                'gen_date_selector': '#graph_gen_date_{{graph.id}}',
                'ordinate_lbl': "{{graph|verbose_ordinate:graph.ordinate}}",
                'abscissa_lbl': "{{graph|verbose_abscissa:graph.abscissa}}  - {{verbose_report_graph_types|get_value:graph.type}}"
            });
        {% endfor %}

        creme.reports.graphs.bind_toggle_graph(selector_{{now}}, function(obj){
            var now = +new Date;
            var loading_id = 'loading_'+now;
            creme.utils.loading(loading_id, false);
            var node = creme.graphael.init(obj.container);
            var date_node = $('#graph_gen_date_'+obj.graph_id);
            creme.graphael.simple_barchart({
               'instance': node.data('graphael'),
               'container':node,
               'x': obj.x,
               'y': obj.y,
               'gen_date_selector': obj.gen_date_selector,
               'abscissa_lbl':obj.abscissa_lbl,
               'ordinate_lbl':obj.ordinate_lbl
            });
            creme.utils.loading(loading_id, true);
        });
    {% endwith %}
</script>